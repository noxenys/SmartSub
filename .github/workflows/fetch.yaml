name: Fetch Subscriptions Source

# è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:

  schedule:
    - cron: '0 20 * * *' # åŒ—äº¬æ—¶é—´å‡Œæ™¨4ç‚¹ (UTC 20:00)
  watch:
    types: started
  # - cron: '0 3,12 * * *'
  # -'0 */1 * * *'

# èµ‹äºˆ GITHUB_TOKEN å†™æƒé™
permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # é˜²æ­¢æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼ˆ30åˆ†é’Ÿè¶…æ—¶ï¼‰
    steps:

    - name: è¿å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
      
    - name: åŠ è½½ç¼“å­˜
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
      
    - name: è®¾ç½®æ—¶åŒº
      run: sudo timedatectl set-timezone 'Asia/Shanghai'

    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r ./requirements.txt
    
    - name: éªŒè¯ Secrets é…ç½®
      env:
        GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GIST_ID: ${{ secrets.GIST_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        chmod +x scripts/validate_secrets.sh
        bash scripts/validate_secrets.sh
        
    - name: Run main.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
      run: |
        python ./main.py || echo "âš ï¸ main.py æ‰§è¡Œé‡åˆ°é”™è¯¯ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

    - name: Run Quality Filter & Push to Telegram
      # åªåœ¨æœ‰èŠ‚ç‚¹æ–‡ä»¶æ—¶æ‰è¿è¡Œç­›é€‰
      if: success() || failure()  # å³ä½¿main.pyå¤±è´¥ä¹Ÿå°è¯•ç­›é€‰
      timeout-minutes: 20  # å•æ­¥è¶…æ—¶é™åˆ¶ï¼ˆé˜²æ­¢IPæ£€æµ‹æˆ–æµ‹è¯•è¿‡å¤šå¯¼è‡´è¶…æ—¶ï¼‰
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        ABUSEIPDB_API_KEY: ${{ secrets.ABUSEIPDB_API_KEY }}
        # ä¼˜å…ˆä½¿ç”¨ GIST_TOKEN (éœ€è¦ç”¨æˆ·åˆ›å»º PAT å¹¶èµ‹äºˆ gist æƒé™)
        # å¦‚æœä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤ GITHUB_TOKEN (é€šå¸¸æ²¡æœ‰ gist æƒé™ï¼Œåªèƒ½ç”¨äºé gist æ“ä½œ)
        GITHUB_TOKEN: ${{ secrets.GIST_TOKEN || secrets.GITHUB_TOKEN }}
        GIST_ID: ${{ secrets.GIST_ID }}
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰èŠ‚ç‚¹å¯ä»¥ç­›é€‰
        if [ -f "sub/sub_all_url_check.txt" ] || [ -f "collected_nodes.txt" ]; then
          echo "âœ… å‘ç°èŠ‚ç‚¹æ–‡ä»¶ï¼Œå¼€å§‹ç­›é€‰..."
          python ./node_quality_filter.py || echo "âš ï¸ èŠ‚ç‚¹ç­›é€‰é‡åˆ°é”™è¯¯"
          
          # ç”Ÿæˆè®¢é˜… URL (å¦‚æœèŠ‚ç‚¹ç­›é€‰æˆåŠŸ)
          if [ -f "sub/high_quality_nodes.txt" ]; then
            echo "ğŸ”— ç”Ÿæˆè®¢é˜… URL..."
            python ./generate_subscription_url.py || echo "âš ï¸ è®¢é˜…URLç”Ÿæˆé‡åˆ°é”™è¯¯"
          else
            echo "âš ï¸ æœªå‘ç°é«˜è´¨é‡èŠ‚ç‚¹æ–‡ä»¶ï¼Œè·³è¿‡è®¢é˜…URLç”Ÿæˆ"
          fi
        else
          echo "âš ï¸ æœªå‘ç°èŠ‚ç‚¹æ–‡ä»¶ï¼Œè·³è¿‡ç­›é€‰"
        fi

        
    - name: Commit
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        # æ·»åŠ æ–‡ä»¶ï¼ˆåˆ†åˆ«å¤„ç†ï¼Œé¿å…ä¸€ä¸ªå¤±è´¥å½±å“å…¨éƒ¨ï¼‰
        git add ./sub || true
        git add ./collected_nodes.txt || true
        git add -f ./failed_subscriptions.log || true
        git add ./blacklist.txt || true
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          git commit -m "ğŸ€ çˆ¬å–è®¢é˜…æº $(date '+%Y-%m-%d %H:%M:%S')"
          
          # æ•è·ä»»ä½•åœ¨ commit åç”Ÿæˆçš„æ–‡ä»¶å˜æ›´
          git add ./sub || true
          git add ./collected_nodes.txt || true
          git add -f ./failed_subscriptions.log || true
          git add ./blacklist.txt || true
          
          # å¦‚æœæœ‰æ–°çš„å˜æ›´ï¼Œè¿½åŠ åˆ°æäº¤
          if ! git diff --staged --quiet; then
            git commit --amend --no-edit
          fi
          
          # Pull latest changes to avoid conflict (ä½¿ç”¨ autostash è‡ªåŠ¨å¤„ç†æœªæš‚å­˜çš„å˜æ›´)
          git pull --rebase --autostash origin main
        fi
        
    - name: æ¨é€æ›´æ”¹
      # åªåœ¨æœ‰æäº¤æ—¶æ‰æ¨é€
      if: success()
      uses:  ad-m/github-push-action@master
      with:
         github_token: ${{ secrets.GITHUB_TOKEN }}
         branch: main
