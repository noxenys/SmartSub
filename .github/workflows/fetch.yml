name: Fetch Subscriptions Source

# è§¦å‘æ¡ä»¶
on:
  workflow_dispatch:

  schedule:
    - cron: '0 20 * * *' # åŒ—äº¬æ—¶é—´å‡Œæ™¨4ç‚¹ (UTC 20:00)
  # watch:
  #   types: started
  # - cron: '0 3,12 * * *'
  # -'0 */1 * * *'

# èµ‹äºˆ GITHUB_TOKEN å†™æƒé™
permissions:
  contents: write

jobs:
  fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # é˜²æ­¢æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼ˆ30åˆ†é’Ÿè¶…æ—¶ï¼‰
    steps:

    - name: è¿å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: å®‰è£…Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: åŠ è½½ç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ç¼“å­˜ä»£ç†äºŒè¿›åˆ¶
      uses: actions/cache@v4
      with:
        path: ~/.cache/smartsub
        key: ${{ runner.os }}-smartsub-binaries-${{ hashFiles('scripts/download_singbox.py', 'scripts/download_mihomo.py') }}
        restore-keys: |
          ${{ runner.os }}-smartsub-binaries-

    - name: è®¾ç½®æ—¶åŒº
      run: sudo timedatectl set-timezone 'Asia/Shanghai'

    - name: å®‰è£…ä¾èµ–
      run: |
        pip install -r ./requirements.txt

    - name: é…ç½®è‡ªæ£€
      run: |
        python scripts/self_check.py || echo "âš ï¸ self_check æç¤ºè­¦å‘Š"

    - name: éªŒè¯ Secrets é…ç½®
      env:
        GIST_TOKEN: ${{ secrets.GIST_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GIST_ID: ${{ secrets.GIST_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        chmod +x scripts/validate_secrets.sh
        bash scripts/validate_secrets.sh

    - name: Run main.py
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        SERVERCHAN_KEY: ${{ secrets.SERVERCHAN_KEY }}
        PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}
      run: |
        python ./main.py || echo "âš ï¸ main.py æ‰§è¡Œé‡åˆ°é”™è¯¯ï¼Œä½†ç»§ç»­æ‰§è¡Œ"

    - name: Select dynamic probe head (optional)
      if: success() || failure()
      run: |
        if [ -s "collected_nodes.txt" ]; then
          echo "ğŸ›°ï¸ Selecting dynamic probe head..."
          python ./node_quality_filter.py --probe-only || echo "âš ï¸ probe-only æ‰§è¡Œå¤±è´¥"
        else
          echo "âš ï¸ collected_nodes.txt ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œè·³è¿‡åŠ¨æ€æ¢æµ‹å¤´"
        fi

    - name: Bootstrap sing-box proxy (optional)
      if: success() || failure()
      env:
        FALLBACK_PROXY_URL: ${{ vars.DYNAMIC_PROBE_PROXY_URL }}
      run: |
        PROXY_URL=""
        mkdir -p runtime
        if [ -f "runtime/probe_head.json" ]; then
          echo "ğŸ§© ç”Ÿæˆ sing-box é…ç½®..."
          python ./scripts/generate_singbox_config.py --probe-json runtime/probe_head.json --output runtime/singbox-probe.json --http-port 7891 --socks-port 7890
          echo "â¬‡ï¸ ä¸‹è½½ sing-box..."
          python ./scripts/download_singbox.py --output ./sing-box
          chmod +x ./sing-box
          ./sing-box version || true
          echo "ğŸ” æ ¡éªŒ sing-box é…ç½®..."
          if ! ./sing-box check -c runtime/singbox-probe.json; then
            echo "âš ï¸ sing-box é…ç½®æ ¡éªŒå¤±è´¥ï¼Œåˆ‡æ¢å¤‡ç”¨å®¢æˆ·ç«¯"
          else
            echo "ğŸš€ å¯åŠ¨ sing-box æœ¬åœ°ä»£ç†..."
            ./sing-box run -c runtime/singbox-probe.json > runtime/singbox.log 2>&1 &
            sleep 5
            if curl -fsS -m 8 --connect-timeout 5 -x http://127.0.0.1:7891 https://www.google.com/generate_204 >/dev/null; then
              PROXY_URL="http://127.0.0.1:7891"
              echo "SINGBOX_PROXY_STARTED=1" >> $GITHUB_ENV
              echo "âœ… sing-box ä»£ç†å¯ç”¨"
            else
              echo "âš ï¸ sing-box ä»£ç†æµ‹è¯•å¤±è´¥ï¼Œåˆ‡æ¢å¤‡ç”¨å®¢æˆ·ç«¯"
              echo "---- sing-box.log (tail) ----"
              tail -n 200 runtime/singbox.log || true
              ps aux | grep '[s]ing-box' || true
              ss -lntp 2>/dev/null | grep 7891 || true
            fi
          fi

          if [ -z "$PROXY_URL" ]; then
            echo "ğŸ§© ç”Ÿæˆ mihomo é…ç½®..."
            python ./scripts/generate_mihomo_config.py --probe-json runtime/probe_head.json --output runtime/mihomo-probe.yaml --mixed-port 7892 --log-level info
            echo "â¬‡ï¸ ä¸‹è½½ mihomo..."
            python ./scripts/download_mihomo.py --output ./mihomo
            chmod +x ./mihomo
            ./mihomo -v || true
            echo "ğŸš€ å¯åŠ¨ mihomo æœ¬åœ°ä»£ç†..."
            ./mihomo -f runtime/mihomo-probe.yaml > runtime/mihomo.log 2>&1 &
            sleep 5
            if curl -fsS -m 8 --connect-timeout 5 -x http://127.0.0.1:7892 https://www.google.com/generate_204 >/dev/null; then
              PROXY_URL="http://127.0.0.1:7892"
              echo "MIHOMO_PROXY_STARTED=1" >> $GITHUB_ENV
              echo "âœ… mihomo ä»£ç†å¯ç”¨"
            else
              echo "âš ï¸ mihomo ä»£ç†æµ‹è¯•å¤±è´¥"
              echo "---- mihomo.log (tail) ----"
              tail -n 200 runtime/mihomo.log || true
              ps aux | grep '[m]ihomo' || true
              ss -lntp 2>/dev/null | grep 7892 || true
            fi
          fi

          if [ -n "$PROXY_URL" ]; then
            echo "DYNAMIC_PROBE_PROXY_URL=$PROXY_URL" >> $GITHUB_ENV
          elif [ -n "$FALLBACK_PROXY_URL" ]; then
            echo "âš ï¸ æœ¬åœ°ä»£ç†å¤±è´¥ï¼Œä½¿ç”¨å›é€€ä»£ç†"
            echo "DYNAMIC_PROBE_PROXY_URL=$FALLBACK_PROXY_URL" >> $GITHUB_ENV
          else
            echo "âš ï¸ æœ¬åœ°ä»£ç†å¤±è´¥ï¼Œä¸”æœªé…ç½®å›é€€ä»£ç†"
          fi
        elif [ -n "$FALLBACK_PROXY_URL" ]; then
          echo "âš ï¸ æœªç”Ÿæˆ probe_head.jsonï¼Œä½¿ç”¨å›é€€ä»£ç†"
          echo "DYNAMIC_PROBE_PROXY_URL=$FALLBACK_PROXY_URL" >> $GITHUB_ENV
        else
          echo "âš ï¸ æœªç”Ÿæˆ probe_head.jsonï¼Œä¸”æœªé…ç½®å›é€€ä»£ç†"
        fi

    - name: Fetch CN probe results (optional)
      env:
        CN_PROBE_URL: ${{ secrets.CN_PROBE_URL }}
        CN_PROBE_TOKEN: ${{ secrets.CN_PROBE_TOKEN }}
      if: ${{ env.CN_PROBE_URL != '' }}
      run: |
        mkdir -p sub
        if [ -n "$CN_PROBE_URL" ]; then
          echo "Fetching CN probe results..."
          if [ -n "$CN_PROBE_TOKEN" ]; then
            curl -fsSL -H "Authorization: Bearer $CN_PROBE_TOKEN" "$CN_PROBE_URL" -o sub/cn_probe.json || echo "âš ï¸ CN probe fetch failed"
          else
            curl -fsSL "$CN_PROBE_URL" -o sub/cn_probe.json || echo "âš ï¸ CN probe fetch failed"
          fi
        fi

    - name: Run Quality Filter & Push to Telegram
      # åªåœ¨æœ‰èŠ‚ç‚¹æ–‡ä»¶æ—¶æ‰è¿è¡Œç­›é€‰
      if: success() || failure()  # å³ä½¿main.pyå¤±è´¥ä¹Ÿå°è¯•ç­›é€‰
      timeout-minutes: 20  # å•æ­¥è¶…æ—¶é™åˆ¶ï¼ˆé˜²æ­¢IPæ£€æµ‹æˆ–æµ‹è¯•è¿‡å¤šå¯¼è‡´è¶…æ—¶ï¼‰
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        ABUSEIPDB_API_KEY: ${{ secrets.ABUSEIPDB_API_KEY }}
        # ä¼˜å…ˆä½¿ç”¨ GIST_TOKEN (éœ€è¦ç”¨æˆ·åˆ›å»º PAT å¹¶èµ‹äºˆ gist æƒé™)
        # å¦‚æœä¸å­˜åœ¨ï¼Œå°è¯•ä½¿ç”¨é»˜è®¤ GITHUB_TOKEN (é€šå¸¸æ²¡æœ‰ gist æƒé™ï¼Œåªèƒ½ç”¨äºé gist æ“ä½œ)
        GITHUB_TOKEN: ${{ secrets.GIST_TOKEN || secrets.GITHUB_TOKEN }}
        GIST_ID: ${{ secrets.GIST_ID }}
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰èŠ‚ç‚¹å¯ä»¥ç­›é€‰
        if [ -f "sub/sub_all_url_check.txt" ] || [ -f "collected_nodes.txt" ]; then
          echo "âœ… å‘ç°èŠ‚ç‚¹æ–‡ä»¶ï¼Œå¼€å§‹ç­›é€‰..."
          python ./node_quality_filter.py || echo "âš ï¸ èŠ‚ç‚¹ç­›é€‰é‡åˆ°é”™è¯¯"

          # ç”Ÿæˆè®¢é˜… URL (å¦‚æœèŠ‚ç‚¹ç­›é€‰æˆåŠŸ)
          if [ -f "sub/high_quality_nodes.txt" ]; then
            echo "ğŸ”— ç”Ÿæˆè®¢é˜… URL..."
            python ./generate_subscription_url.py || echo "âš ï¸ è®¢é˜…URLç”Ÿæˆé‡åˆ°é”™è¯¯"
          else
            echo "âš ï¸ æœªå‘ç°é«˜è´¨é‡èŠ‚ç‚¹æ–‡ä»¶ï¼Œè·³è¿‡è®¢é˜…URLç”Ÿæˆ"
          fi
        else
          echo "âš ï¸ æœªå‘ç°èŠ‚ç‚¹æ–‡ä»¶ï¼Œè·³è¿‡ç­›é€‰"
        fi

    - name: Commit
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

        # æ·»åŠ æ–‡ä»¶ï¼ˆåˆ†åˆ«å¤„ç†ï¼Œé¿å…ä¸€ä¸ªå¤±è´¥å½±å“å…¨éƒ¨ï¼‰
        git add ./sub || true
        git add ./collected_nodes.txt || true
        git add -f ./failed_subscriptions.log || true
        git add ./blacklist.txt || true

        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "ğŸ“ æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          git commit -m "ğŸ€ çˆ¬å–è®¢é˜…æº $(date '+%Y-%m-%d %H:%M:%S')"

          # æ•è·ä»»ä½•åœ¨ commit åç”Ÿæˆçš„æ–‡ä»¶å˜æ›´
          git add ./sub || true
          git add ./collected_nodes.txt || true
          git add -f ./failed_subscriptions.log || true
          git add ./blacklist.txt || true

          # å¦‚æœæœ‰æ–°çš„å˜æ›´ï¼Œè¿½åŠ åˆ°æäº¤
          if ! git diff --staged --quiet; then
            git commit --amend --no-edit
          fi

          # Pull latest changes to avoid conflict (ä½¿ç”¨ autostash è‡ªåŠ¨å¤„ç†æœªæš‚å­˜çš„å˜æ›´)
          git pull --rebase --autostash origin main
        fi

    - name: æ¨é€æ›´æ”¹
      # åªåœ¨æœ‰æäº¤æ—¶æ‰æ¨é€
      if: success()
      uses:  ad-m/github-push-action@master
      with:
         github_token: ${{ secrets.GITHUB_TOKEN }}
         branch: main
